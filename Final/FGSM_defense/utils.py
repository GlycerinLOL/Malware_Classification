import cv2
import numpy as np
import os
from PIL import Image
from torchvision import transforms
import matplotlib.pyplot as plt
from pathlib import Path
from tqdm import tqdm

folder = "D:\\code\\Malware_Classification\\datasets\\testDataset"
imgSaveFolder = "D:\\code\\Malware_Classification\\Final\\FGSM_defense\\img"

def main():
    # kernel_size = [1, 3, 5, 7] sigma = [0.01, 2]
    img = Image.open(folder + "\\benign\\deinterlace.png")
    # resize => 128 * 128
    img = img.resize((128, 128))
    for k in [1, 3, 5, 7]:
        gb = transforms.GaussianBlur(k, sigma=(0.01, 2.0))
        img = gb(img)
        img.save(imgSaveFolder + "\\deinterlace_gb_" + str(k) + ".png")

def draw():
    '''
    kernel_size, e=0, e=0.005, e=0.01, e=0.015
    1, 94, 58, 15, 8
    3, 85, 50, 20, 12
    5, 81, 47, 27, 13
    7, 78, 48, 28, 13
    using dots to draw the line
    '''
    x = [0, 0.005, 0.01, 0.015]
    y1 = [94, 58, 15, 8]
    y2 = [94, 29, 9, 7]
    y3 = [97, 36, 11, 4]
    plt.plot(x, y1, 'ro-', label='adv 0%')
    plt.plot(x, y2, 'bo-', label='adv 20%')
    plt.plot(x, y3, 'go-', label='adv 50%')
    plt.xlabel('epsilon')
    plt.ylabel('accuracy')
    plt.title('Adversarial Training Defense')
    plt.grid()
    plt.legend()
    plt.show()

def combineTwoDirectory():
    targetFolder = "D:\\code\\Malware_Classification\\datasets\\malwares_images_virus31320"
    sourceFolder = "D:\\code\\Malware_Classification\\datasets\\malwares_images_virus31320_adv"
    # combine two folders from sourceFolder to targetFolder
    cnt = 0
    for folder in tqdm(Path(sourceFolder).glob("*")):
        print(folder)
        for file in folder.glob("*"):
            # copy the file to targetFolder
            os.system("copy " + str(file) + " " + str(targetFolder) + "\\" + str(folder).split("\\")[-1] + "\\" + Path(file).name)
            cnt+=1
    print("Total files copied: ", cnt)

def drawDatasetDistribution():
    # folder = "D:\\code\\Malware_Classification\\datasets\\malwares_images_virus31320"
    folder = "D:\\code\\Malware_Classification\\datasets\\testDataset"
    # count the number of images in each class
    cnt = {}
    total = 0
    for folder in Path(folder).glob("*"):
        cnt[str(folder).split("\\")[-1]] = len(list(folder.glob("*")))
        total += len(list(folder.glob("*")))
    print(cnt)
    print("Total images: ", total)
    # draw the bar chart
    fs = 14
    plt.bar(cnt.keys(), cnt.values())
    plt.xlabel('Class', fontsize=fs)
    plt.ylabel('Number of Images', fontsize=fs)
    plt.title('Dataset Distribution', fontsize=fs)
    plt.xticks(fontsize=fs, rotation=45, ha='right')
    plt.yticks(fontsize=fs)
    plt.show()

def deleteImgWithAdv():
    cnt = 0
    folder = "D:\\code\\Malware_Classification\\datasets\\malwares_images_virus31320"
    for folder in Path(folder).glob("*"):
        for file in folder.glob("*"):
            if "adv" in Path(file).name:
                os.remove(file)
                print("Deleted: ", file)
                cnt+=1
                # return 0
    print("Total files deleted: ", cnt)
if __name__ == "__main__":
    # deleteImgWithAdv()
    drawDatasetDistribution()